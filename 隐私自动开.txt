import sqlite3
import json
import os
import re
import shutil
import time
import platform

def get_default_db_path():
    """
    根据操作系统自动获取 Trae 的 state.vscdb 路径
    """
    system = platform.system()
    
    if system == "Windows":
        # 获取 %APPDATA% 路径 (例如 C:\Users\YourName\AppData\Roaming)
        appdata = os.getenv('APPDATA')
        if appdata:
            return os.path.join(appdata, "Trae", "User", "globalStorage", "state.vscdb")
    
    elif system == "Darwin": # macOS
        return os.path.expanduser("~/Library/Application Support/Trae/User/globalStorage/state.vscdb")
    
    elif system == "Linux":
        return os.path.expanduser("~/.config/Trae/User/globalStorage/state.vscdb")
    
    return None

def backup_db(file_path):
    """创建数据库备份"""
    if not os.path.exists(file_path):
        return False
    
    backup_path = file_path + f".backup_{int(time.time())}"
    try:
        shutil.copy2(file_path, backup_path)
        print(f"✅ 已创建备份：{os.path.basename(backup_path)}")
        return True
    except Exception as e:
        print(f"❌ 备份失败：{e}")
        return False

def find_user_ids(cursor):
    """
    扫描数据库，通过特征 Key (currentAgentData_*) 提取所有 User ID。
    """
    cursor.execute("SELECT key FROM ItemTable")
    all_keys = cursor.fetchall()
    
    user_ids = set()
    # 匹配 currentAgentData_ 后面的数字串
    pattern = re.compile(r"currentAgentData_(\d+)")
    
    for (key,) in all_keys:
        if key:
            match = pattern.search(key)
            if match:
                user_ids.add(match.group(1))
    
    return list(user_ids)

def enable_privacy_for_user(cursor, user_id):
    """
    为指定 User ID 强制写入隐私设置
    """
    timestamp = int(time.time() * 1000)
    
    # 1. 设置 appPrivacyMode 为 "on"
    key_mode = f"appPrivacyMode:{user_id}"
    val_mode = "on"
    
    # 2. 设置操作类型记录
    key_op = f"ai.privacy_mode_{user_id}.operationType"
    val_op_dict = {
        "type": "manual",
        "timeStamp": timestamp
    }
    val_op = json.dumps(val_op_dict)

    try:
        cursor.execute("INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)", (key_mode, val_mode))
        cursor.execute("INSERT OR REPLACE INTO ItemTable (key, value) VALUES (?, ?)", (key_op, val_op))
        print(f"   [+] 用户 {user_id}: 隐私模式已强制开启")
        return True
    except Exception as e:
        print(f"   [-] 用户 {user_id}: 设置失败 - {e}")
        return False

def main():
    # 1. 自动获取路径
    db_path = get_default_db_path()
    
    if not db_path:
        print("❌ 无法确定 Trae 数据库路径。")
        return

    print(f"🔍 目标数据库: {db_path}")

    if not os.path.exists(db_path):
        print("❌ 错误：找不到 state.vscdb 文件。请确认 Trae 是否已安装并至少运行过一次。")
        return

    # 2. 备份
    if not backup_db(db_path):
        return

    try:
        # 3. 连接数据库
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()

        # 4. 查找所有用户 ID
        user_ids = find_user_ids(cursor)
        
        if not user_ids:
            print("⚠️ 未在数据库中找到任何 User ID。")
        else:
            print(f"🔎 发现 {len(user_ids)} 个用户 ID: {user_ids}")
            
            changes_made = 0
            for uid in user_ids:
                if enable_privacy_for_user(cursor, uid):
                    changes_made += 1
            
            # 5. 提交更改
            if changes_made > 0:
                conn.commit()
                print("💾 数据库已保存更新。")
            else:
                print("✨ 无需更改，所有用户已开启隐私模式。")

        conn.close()
        print("\n🎉 完成！请重启 Trae 以生效。")

    except sqlite3.Error as e:
        print(f"❌ 数据库错误 (可能文件被占用): {e}")
        print("💡 建议：请先完全关闭 Trae 编辑器再运行此脚本。")
    except Exception as e:
        print(f"❌ 未知错误: {e}")

if __name__ == "__main__":
    main()